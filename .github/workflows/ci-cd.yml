name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "Installing dependencies from requirements.txt:"
        cat requirements.txt
        pip install -r requirements.txt
        echo "Installed packages:"
        pip list

    - name: Verify project structure
      run: |
        echo "📁 Project Structure:"
        ls -la
        echo "📁 App Directory:"
        ls -la app/
        echo "🐍 Python Files:"
        find . -name "*.py" -type f

    - name: Test all Python imports
      run: |
        echo "Testing all Python imports..."
        python -c "import flask; print('✅ Flask import successful')"
        python -c "import flask_cors; print('✅ Flask CORS import successful')"
        python -c "import groq; print('✅ Groq import successful')"
        python -c "import firebase_admin; print('✅ Firebase import successful')"
        python -c "import hashlib; print('✅ hashlib import successful')"
        python -c "import os; print('✅ os import successful')"
        python -c "import re; print('✅ re import successful')"
        python -c "from datetime import datetime, timedelta; print('✅ datetime import successful')"
        python -c "import json; print('✅ json import successful')"
        python -c "import random; print('✅ random import successful')"
        python -c "import requests; print('✅ requests import successful')"
        echo "✅ All Python imports successful!"

    - name: Create test script for app import
      run: |
        cat > test_app_import.py << 'EOF'
import os
# Set mock environment variables for testing
os.environ['GROQ_API_KEY'] = 'test-key-for-ci'
os.environ['FIREBASE_CONFIG_PATH'] = 'mock_firebase.json'

try:
    from app.app import app
    print('✅ App import successful!')
    
    # Test that the Flask app was created
    print(f'✅ Flask app name: {app.name}')
    
    # Test basic route registration
    with app.test_client() as client:
        response = client.get('/')
        print(f'✅ Root route status: {response.status_code}')
        
except Exception as e:
    print(f'❌ App import failed: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
EOF

    - name: Test app import with mock environment
      run: python test_app_import.py

    - name: Build Docker image
      run: |
        echo "Building Docker image..."
        docker build -t cooking-helper .

    - name: Test Docker container basics
      run: |
        echo "Testing Docker container..."
        # Test that the container can be built and run basic commands
        docker build -t cooking-helper-test .
        docker run --rm cooking-helper-test python -c "import sys; print('Python version:', sys.version); print('✅ Basic Docker test passed')"

    - name: Cleanup
      run: rm -f test_app_import.py

    - name: Success
      run: |
        echo '🎉 CI/CD Pipeline Completed Successfully!'
        echo '✅ All dependencies installed'
        echo '✅ All imports working'
        echo '✅ App imports correctly'
        echo '✅ Docker image builds successfully'
